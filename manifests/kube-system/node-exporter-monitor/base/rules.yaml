# Copyright (C) 2016, 2019 Nicolas Lamirault <nicolas.lamirault@gmail.com>

# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  labels:
    k8s-app: node-exporter-monitor
    prometheus: cluster
  name: node-exporter-monitor
spec:
  groups:
    - name: node.rules
      rules:
        - record: instance:node_cpu:rate:sum
          expr: sum(rate(node_cpu{mode!="idle",mode!="iowait"}[3m]))
            BY (instance)
        - record: instance:node_filesystem_usage:sum
          expr:
            sum((node_filesystem_size{mountpoint="/"} - node_filesystem_free{mountpoint="/"}))
            BY (instance)
        - record: instance:node_network_receive_bytes:rate:sum
          expr: sum(rate(node_network_receive_bytes[3m])) BY (instance)
        - record: instance:node_network_transmit_bytes:rate:sum
          expr: sum(rate(node_network_transmit_bytes[3m])) BY (instance)
        - record: instance:node_cpu:ratio
          expr:
            sum(rate(node_cpu{mode!="idle",mode!="iowait"}[5m])) WITHOUT (cpu, mode) / ON(instance)
            GROUP_LEFT() count(sum(node_cpu) BY (instance, cpu)) BY (instance)
        - record: cluster:node_cpu:sum_rate5m
          expr: sum(rate(node_cpu{mode!="idle",mode!="iowait"}[5m]))
        - record: cluster:node_cpu:ratio
          expr: cluster:node_cpu:rate5m / count(sum(node_cpu) BY (instance, cpu))
        - alert: NodeExporterDown
          expr: absent(up{job="node-exporter"} == 1)
          for: 10m
          labels:
            severity: warning
          annotations:
            description:
              Prometheus could not scrape a node-exporter for more than 10m,
              or node-exporters have disappeared from discovery
            summary: Prometheus could not scrape a node-exporter
        - alert: NodeDiskRunningFull
          expr: predict_linear(node_filesystem_free{job="node-exporter",mountpoint!~"^/etc/(?:resolv.conf|hosts|hostname)$"}[30m], 3600 * 2) < 0 and on(instance) up{job="node-exporter"} and on(instance) (time() - node_boot_time > (60 * 60 * 24))
          for: 10m
          labels:
            severity: critical
          annotations:
            description:
              device {{$labels.device}} on node {{$labels.instance}} is running
              full within the next 2 hours (mounted at {{$labels.mountpoint}})
            summary: Node disk is running full within 2 hours